import os


def mem_allowed(wildcards, threads):
    return max(threads * 6400, 6400)

from snakemake.utils import validate

validate(config, "schema/config.schema.yaml")

include: "rules/epang.smk"
include: "rules/metabuli.smk"
include: "rules/sintax.smk"
include: "rules/kaiju.smk"


def all_input(wildcards):
    input = []
    if "metabuli" in config["tools"]:
        input += expand("results/metabuli/{ref}/classify/{run}/{query}_{f}.tsv", 
            ref=config["metabuli"]["ref"].keys(), 
            run=config["metabuli"]["runs"].keys(),
            query=config["metabuli"]["query"].keys(),
            f=["classifications","report"])
    if "epa-ng" in config["tools"]:
        input+=expand(
            "results/taxonomy/{ref}/{run}/taxonomy.tsv",
            run=config["run"],
            ref=ref_name,
        )
        input+=expand(
            "results/taxonomy/{ref}/{run}/config.yml", run=config["run"], ref=ref_name
        ),
        input+=expand(
            "results/taxonomy/{ref}/{run}/software.txt",
            run=config["run"],
            ref=ref_name,
        ),
    return input


rule all:
    input:
        all_input
